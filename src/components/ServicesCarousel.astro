---
import { getCollection } from 'astro:content';

const base = import.meta.env.BASE_URL;
const services = await getCollection('services');
const sortedServices = services.sort((a, b) => a.data.order - b.data.order);
---

<section id="services" class="services-carousel-section">
  <div class="container">
    <h2 class="text-center">Наши услуги</h2>
    <p class="section-description">
      Комплексные решения для вашего бизнеса — от идеи до запуска
    </p>

    <div class="carousel-wrapper">
      <button class="carousel-btn carousel-btn-prev" aria-label="Предыдущая услуга">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>

      <div class="carousel-container">
        <div class="carousel-track">
          {sortedServices.map((service) => (
            <article class="service-card" data-service-index={service.data.index}>
              <a href={`${base}services/${service.slug}/`} class="service-card-link">
                <div class="service-icon">{service.data.icon}</div>
                <h3>{service.data.title}</h3>
                <p class="service-description">{service.data.shortDescription}</p>
                <div class="service-footer">
                  <span class="service-price">{service.data.price}</span>
                  <span class="service-arrow">→</span>
                </div>
              </a>
            </article>
          ))}
        </div>
      </div>

      <button class="carousel-btn carousel-btn-next" aria-label="Следующая услуга">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>

    <div class="carousel-dots">
      {sortedServices.map((_, index) => (
        <button 
          class={`carousel-dot ${index === 0 ? 'active' : ''}`}
          data-index={index}
          aria-label={`Перейти к услуге ${index + 1}`}
        />
      ))}
    </div>

    <div class="carousel-cta">
      <a href={`${base}services/`} class="btn btn-secondary">Все услуги</a>
    </div>
  </div>
</section>

<style>
  .services-carousel-section {
    padding: 5rem 2rem;
    background: linear-gradient(135deg, rgba(61, 17, 57, 0.02), rgba(229, 28, 39, 0.02));
  }

  .section-description {
    text-align: center;
    color: var(--color-text);
    opacity: 0.8;
    margin-bottom: 3rem;
    font-size: 1.125rem;
  }

  .carousel-wrapper {
    position: relative;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 3rem;
  }

  .carousel-container {
    overflow: hidden;
    position: relative;
  }

  .carousel-track {
    display: flex;
    transition: transform 0.5s ease-in-out;
    gap: 2rem;
  }

  .service-card {
    flex: 0 0 calc(50% - 1rem);
    min-width: 0;
  }

  .service-card-link {
    display: flex;
    flex-direction: column;
    height: 100%;
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(61, 17, 57, 0.08);
    text-decoration: none;
    color: inherit;
    transition: all 0.3s ease;
  }

  .service-card-link:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 40px rgba(61, 17, 57, 0.15);
  }

  .service-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  .service-card h3 {
    font-family: var(--font-heading);
    font-weight: 400;
    font-size: 1.25rem;
    color: var(--color-primary);
    margin-bottom: 1rem;
    line-height: 1.4;
    min-height: 3.5rem;
  }

  .service-description {
    color: var(--color-text);
    opacity: 0.8;
    line-height: 1.6;
    margin-bottom: 1.5rem;
    flex-grow: 1;
  }

  .service-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 1rem;
    border-top: 1px solid rgba(61, 17, 57, 0.1);
  }

  .service-price {
    font-weight: 700;
    color: var(--color-secondary);
    font-size: 1.125rem;
  }

  .service-arrow {
    font-size: 1.5rem;
    color: var(--color-primary);
    transition: transform 0.3s ease;
  }

  .service-card-link:hover .service-arrow {
    transform: translateX(5px);
  }

  .carousel-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: white;
    border: 2px solid var(--color-primary);
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 10;
  }

  .carousel-btn:hover {
    background: var(--color-primary);
    color: white;
  }

  .carousel-btn svg {
    width: 24px;
    height: 24px;
  }

  .carousel-btn-prev {
    left: 0;
  }

  .carousel-btn-next {
    right: 0;
  }

  .carousel-dots {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 2rem;
  }

  .carousel-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: rgba(61, 17, 57, 0.2);
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .carousel-dot.active {
    background: var(--color-primary);
    width: 32px;
    border-radius: 6px;
  }

  .carousel-cta {
    text-align: center;
    margin-top: 3rem;
  }

  .btn {
    display: inline-block;
    padding: 0.875rem 2rem;
    font-family: var(--font-body);
    font-weight: 700;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    font-size: 0.95rem;
  }

  .btn-secondary {
    background: white;
    color: var(--color-primary);
    border: 2px solid var(--color-primary);
  }

  .btn-secondary:hover {
    background: var(--color-primary);
    color: white;
  }

  /* Адаптивность */
  @media (max-width: 768px) {
    .services-carousel-section {
      padding: 3rem 1rem;
    }

    .carousel-wrapper {
      padding: 0 2.5rem;
    }

    .service-card {
      flex: 0 0 100%;
    }

    .carousel-btn {
      width: 40px;
      height: 40px;
    }

    .carousel-btn svg {
      width: 20px;
      height: 20px;
    }
  }
</style>

<script>
  class ServicesCarousel {
    private track: HTMLElement;
    private cards: NodeListOf<HTMLElement>;
    private dots: NodeListOf<HTMLElement>;
    private prevBtn: HTMLElement;
    private nextBtn: HTMLElement;
    private currentIndex = 0;
    private cardsToShow = 2;

    constructor() {
      this.track = document.querySelector('.carousel-track') as HTMLElement;
      this.cards = document.querySelectorAll('.service-card') as NodeListOf<HTMLElement>;
      this.dots = document.querySelectorAll('.carousel-dot') as NodeListOf<HTMLElement>;
      this.prevBtn = document.querySelector('.carousel-btn-prev') as HTMLElement;
      this.nextBtn = document.querySelector('.carousel-btn-next') as HTMLElement;

      this.updateCardsToShow();
      this.init();
      
      window.addEventListener('resize', () => {
        this.updateCardsToShow();
        this.updateCarousel();
      });
    }

    private updateCardsToShow() {
      const width = window.innerWidth;
      if (width <= 768) {
        this.cardsToShow = 1;
      } else {
        this.cardsToShow = 2;
      }
    }

    private init() {
      this.prevBtn.addEventListener('click', () => this.prev());
      this.nextBtn.addEventListener('click', () => this.next());

      this.dots.forEach((dot, index) => {
        dot.addEventListener('click', () => this.goToSlide(index));
      });

      // Touch support
      let startX = 0;
      let currentX = 0;
      let isDragging = false;

      this.track.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        isDragging = true;
      });

      this.track.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        currentX = e.touches[0].clientX;
      });

      this.track.addEventListener('touchend', () => {
        if (!isDragging) return;
        const diff = startX - currentX;
        if (Math.abs(diff) > 50) {
          if (diff > 0) {
            this.next();
          } else {
            this.prev();
          }
        }
        isDragging = false;
      });
    }

    private updateCarousel() {
      const cardWidth = this.cards[0].offsetWidth;
      const gap = 32; // 2rem
      const offset = -(this.currentIndex * (cardWidth + gap));
      
      this.track.style.transform = `translateX(${offset}px)`;
      
      this.dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === this.currentIndex);
      });
    }

    private next() {
      const maxIndex = this.cards.length - this.cardsToShow;
      if (this.currentIndex < maxIndex) {
        this.currentIndex++;
        this.updateCarousel();
      }
    }

    private prev() {
      if (this.currentIndex > 0) {
        this.currentIndex--;
        this.updateCarousel();
      }
    }

    private goToSlide(index: number) {
      const maxIndex = this.cards.length - this.cardsToShow;
      this.currentIndex = Math.min(index, maxIndex);
      this.updateCarousel();
    }
  }

  // Initialize carousel when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => new ServicesCarousel());
  } else {
    new ServicesCarousel();
  }
</script>